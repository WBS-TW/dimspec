---
title: "Peak Gather Example"
author: "bjp"
date: "7/14/2021"
output: pdf_document
---

# Example of gathering data for DB input

Include all necessary packages:

```{r setup, message = FALSE}
source('src/compliance.R')
```

## Step 1) Load Method JSON data and mzML data

```{r loadfile}
jsonfile <- 'example/PFAC30PAR_PFCA2_mzML.JSON'
methodjson <- parse_methodjson(jsonfile)
mzmlfile <- paste(dirname(jsonfile), "/", methodjson$sample$filename, sep = "")
mzml <- mzMLtoR(mzmlfile)
```

**JSON Data**

Sample Info:

```{r sampleinfo, echo=FALSE}
knitr::kable(cbind(names(methodjson$sample), methodjson$sample), row.names = FALSE)
```

Chromatography Info:
```{r chromatographyinfo, echo=FALSE}
knitr::kable(cbind(names(methodjson$chromatography), methodjson$chromatography), row.names = FALSE)
```

Mass Spectrometry Info:

```{r massspectrometryinfo, echo=FALSE}
knitr::kable(cbind(names(methodjson$massspectrometry), methodjson$massspectrometry), row.names = FALSE)
```

QC Method Info:

```{r qcmethodinfo, echo=FALSE}
knitr::kable(cbind(names(methodjson$qcmethod), methodjson$qcmethod), row.names = FALSE)
```

Peaklist:

```{r peaklist, echo=FALSE}
knitr::kable(do.call(rbind, lapply(methodjson$peaks, function(x) data.frame(x))), row.names = FALSE)
```

## Step 2) For each peak in the peak list, gather method data, peak data, and peak-specific MS data.

The data is also matched against the compound list to pair **COMPOUND ID** values. A surrogate will be the 'src/gather/pfas_cmpds.csv' file.

```{r gather}
compoundtable <- read.csv('src/gather/pfas_cmpds.csv', header = TRUE, row.names = NULL)
dat <- peak_gather_json(methodjson, mzml, compoundtable)
```

Example dataset:

```{r peakdata}
i <- 2 ## because there were no annotations for peak 1
dat[[i]]$peak
```
**MS1**

```{r ms1plot}
ms1range = c(0.5, 3)
ms1list <- lapply(dat[[i]]$msdata, function(x) {if (x$msn == 1) {matrix(unzip(x$msdata), ncol = 2, byrow = TRUE)}})
  ms1list <- lapply(ms1list, function(x) x[which(x[,1] >= as.numeric(dat[[i]]$peak$mz) - ms1range[1] & x[,1] <= as.numeric(dat[[i]]$peak$mz) + ms1range[2]),])
  ms1list <- ms1list[-which(sapply(lapply(ms1list, nrow), is.null))]
  ms1list <- lapply(ms1list, zipms)
  ms1empirical <- peaktable(ms1list, masserror = as.numeric(dat[[i]]$massspectrometry$msaccuracy))
  ms1empirical <- data.frame(mz = rowMeans(ms1empirical$mass, na.rm = TRUE), int = rowMeans(ms1empirical$int, na.rm = TRUE))
  plot(ms1empirical, type = "h")
```

**MS2**

```{r ms2plot}
 ms2list <- lapply(dat[[i]]$msdata, function(x) {if (x$msn == 2) {x$msdata}})
    ms2list <- ms2list[-which(sapply(ms2list, function(x) length(nchar(x)) == 0))]
    ms2empirical <- peaktable(ms2list, masserror = as.numeric(dat[[i]]$massspectrometry$msaccuracy))
    ms2empirical <- data.frame(mz = rowMeans(ms2empirical$mass, na.rm = TRUE), int = rowMeans(ms2empirical$int, na.rm = TRUE))
  plot(ms2empirical, type = "h")
```

**Annotations:**

```{r annotations}
knitr::kable(dat[[i]]$annotation)
```


## Step 3) Data Quality Check

To perform a automated check on quality, for each peak

```{r qualitycheck}
qc <- gather_qc(dat[[i]], exactmasses)
```

```{r echo = FALSE}
knitr::kable(qc[[1]], row.names = FALSE)
```

```{r echo = FALSE}
knitr::kable(qc[[2]], row.names = FALSE)
```

```{r echo = FALSE}
knitr::kable(qc[[3]], row.names = FALSE)
```

```{r echo = FALSE}
knitr::kable(qc[[4]], row.names = FALSE)
```

```{r echo = FALSE}
knitr::kable(qc[[5]], row.names = FALSE)
```

```{r echo = FALSE}
knitr::kable(qc[[6]], row.names = FALSE)
```

```{r echo = FALSE}
knitr::kable(qc[[7]], row.names = FALSE)
```

**write file for future reference**
```{r save}
saveRDS(dat, 'example/PFAC30PAR_PFCA2_output.RDS')
```

