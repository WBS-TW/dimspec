---
title: "Aggregate functions (Example)"
output:
  pdf_document: default
---

```{r bkg, echo = FALSE, message = FALSE, error = FALSE}
knitr::opts_knit$set(root.dir = gsub('/doc', '', getwd()))
```


# 1) Install Dependencies and Initialize Environment

```{r init, message=FALSE}
#install dependencies and verify directories
source('src/compliance.R')

#copy example files to Input folder
examples <- list.files(path = "example", full.names = TRUE)
file.copy(examples, 'input', overwrite = TRUE)
```

Within the environment, the object *'fragments'* was included from *'src/aggregate/fragment_table.csv'* containing a list of possible fragments with fragment-specific information available.

```{r fragment_header, echo=FALSE}
knitr::kable(head(fragments), format = 'latex')
```

# 2) Import Peak List

A peak list consists of the minimum information needed to extract compound-specific MS data from the designated mzML or other raw data file. Metadata files, such as the LC Method (if separate from the MS Method), MS Method, and QC Method are included for aggregation.

```{r peaklist}
peaklist_loc = "input/example_peaklist.csv"

peaklist <- read.csv(peaklist_loc, header = TRUE, row.names = NULL)

knitr::kable(peaklist, format = 'latex')
```

# 3) Search fragments & aggregate peaklist data

The *aggregate_fragments* function extracts MS2 data for each compound, based on the peak list information, and attempts to identify any annotatable fragments from the *fragments* object, based on instrument accuracy.

```{r aggregate}
masserror = 10 #instrument accuracy (ppm)
minerror = 0.002 #minimum instrument accuracy (Da)
correl = NULL #correlation coefficient for MS2 ions to MS1 precursor ion
ph = NULL #minimum chromatographic peak height (%) above which to include MS2 ions
freq = NULL #minimum observational frequency (%) for MS2 ions to be included
# For more information on these parameters, see DOI: 10.1021/jasms.0c00423

peaklist_aggregate <- aggregate_fragments(peaklist, fragments, masserror, minerror, correl, ph, freq)

saveRDS(peaklist_aggregate, file = 'output/example/peaklist_aggregate_example.RDS')
```

Based on the example aggregation, there are `r length(grep("ID", names(peaklist_aggregate)))` compounds with annotatable MS2 fragments.


